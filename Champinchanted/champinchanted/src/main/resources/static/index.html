<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Champinchanted</title>

    <!-- LIBRERÍAS PARA WEBSOCKETS -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <!-- LIBRERÍA DE PHASER -->
    <script src="//cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.js"></script>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.86.0/phaser.min.js"></script>
    <script src="js/intro.js"></script>
    <script src="js/game.js"></script>
    <script src="js/endgame.js"></script>
    <script src="js/endgameonline.js"></script>
    <script src="js/credits.js"></script>
    <script src="js/personajesgame.js"></script>
    <script src="js/mapagame.js"></script>
    <script src="js/tutorial.js"></script>
    <script src="js/username.js"></script>
    <script src="js/mapagameonline.js"></script>
    <script src="js/personajesgameonline.js"></script>
    <script src="js/gameonline.js"></script>
    <script src="js/sessionManager.js"></script>


</head>

<body>
    <div id="game-canvas"></div> <!-- Canvas del juego controlado por Phaser -->
    <script>
        var gameCode = "";
        // Configuración de Phaser -----------------------------------------------------------------------------------------
        const config = {
            type: Phaser.AUTO,          // Elección del método de renderizado en función de las capacidades del navegador
            width: 1920,                // Ancho de la pantalla
            height: 1080,               // Alto de la pantalla
            parent: 'game-canvas',      // Contenedor donde se renderiza el juego
            backgroundColor: '#000000', // Color del fondo

            physics: {                  // FÍSICAS DEL JUEGO ---------------------------------------------------------------
                default: 'arcade',
                arcade: {
                    debug: false,        // Activa el modo de depuración mostrando colisiones y bordes
                    gravity: { y: 1900 } // Aplica la gravedad vertical
                }
            },
            scene: [IntroGame,          // ESCENAS DEL JUEGO ---------------------------------------------------------------
                GameScene,
                UsernameScene,
                EndGame,
                EndGameOnline,
                CreditsScene,
                TutorialScene,
                PersonajesGame,
                PersonajesGameOnline,
                MapaGameOnline,
                MapaGame,
                GameSceneOnline],

            scale: {
                mode: Phaser.Scale.FIT,                 // Escala el juego para ajustarse a la ventana
                autoCenter: Phaser.Scale.CENTER_BOTH    // Centra el juego en la ventana
            }
        };

        // Creación del juego ----------------------------------------------------------------------------------------------
        const game = new Phaser.Game(config);   // Crea una nueva intancia del juego con la configuración definida

        async function startGame() {
            //const random = Math.floor(Math.random() * 1000) + 1;
            //gameCode = "partida" + random;
            gameCode = "partida";
            window.gameCode = gameCode; // Asignar globalmente

            try {
                const response = await fetch("/api/games", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ code: gameCode })
                });

                if (response.ok) {
                    console.log('Juego iniciado correctamente');
                    return true;
                } else if (response.status === 409) {
                    console.log('El código de partida ya existe, creando uno nuevo');
                    return startGame();
                } else {
                    const errorText = await response.text();
                    console.error('Hubo un problema al iniciar el juego:', response.status, errorText);
                    return false;
                }
            } catch (error) {
                console.error("Error al inicial el juego: ", error)
                return false;
            }
        }

        async function initializeGame() {
            const gameStarted = await startGame();
            if (gameStarted) {
                game.scene.start('IntroScene'); // Solo iniciar la escena cuando el juego esté correctamente inicializado
            } else {
                alert("Hubo un problema al iniciar el juego. Intenta nuevamente.");
            }
        }

        initializeGame();

        function eliminarUsuario() {
            const username = sessionManager.getUsername();

            if (username) {
                fetch(`/api/users/${username}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            console.log("Usuario eliminado con éxito.");
                        } else {
                            console.error("Hubo un problema al eliminar el usuario.");
                            alert("Hubo un error al intentar eliminar tu cuenta. Por favor, intenta nuevamente.");
                        }
                    })
                    .catch(error => {
                        console.error("Error en la solicitud: ", error);
                        alert("No se pudo eliminar el usuario debido a un problema de conexión. Por favor, revisa tu conexión a internet.");
                    })
            } else {
                console.error("No se ha encontrado el nombre de usuario.");
            }
        }

        window.addEventListener("beforeunload", function (event) {
            if (sessionManager && sessionManager.stopHeartbeat && sessionManager.getUsername()) {
                sessionManager.stopHeartbeat();  // Detén el heartbeat si está definido
            }
            setTimeout(eliminarUsuario, 500);  // Espera antes de intentar eliminar el usuario
        });

        game.scene.start('IntroScene');         // Phaser inicializa el juego

    </script>
</body>

</html>